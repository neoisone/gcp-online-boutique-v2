name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  TF_WORKING_DIR: terraform

jobs:
  tf-check:
    name: Terraform lint & validate
    runs-on: ubuntu-latest
    outputs:
      plan_artifact: ${{ steps.upload.outputs.artifact-path || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform fmt check
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -var="project_id=${{ secrets.GCP_PROJECT }}" -var="env=dev" -out=tfplan -input=false

      - name: Upload plan artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKING_DIR }}/tfplan

  test-apps:
    name: Run application tests
    runs-on: ubuntu-latest
    needs: tf-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run frontend unit tests
        working-directory: services/frontend
        run: go test ./...

  infra-deploy:
    name: Apply infrastructure (Terraform)
    runs-on: ubuntu-latest
    needs: [tf-check, test-apps]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set GCP project
        run: gcloud config set project ${{ secrets.GCP_PROJECT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform init (reconfigure)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -reconfigure -input=false

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve -var="project_id=${{ secrets.GCP_PROJECT }}" -var="env=dev"

  app-deploy:
    name: Deploy applications to GKE
    runs-on: ubuntu-latest
    needs: infra-deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Deploy upstream manifests (kustomize)
        run: kubectl apply -k upstream-microservices/kubernetes-manifests

      - name: Patch frontend to GHCR image
        run: kubectl set image deployment/frontend server=ghcr.io/${{ github.repository_owner }}/frontend:latest -n default
